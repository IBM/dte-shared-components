Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};exports.loadPopularSuggestions=loadPopularSuggestions;exports.executeQuery=executeQuery;exports.setQueryOptions=setQueryOptions;exports.updateQuery=updateQuery;exports.loadMore=loadMore;var _value=require('./value');var _utils=require('./utils');var _hits=require('./hits');var _misc=require('./misc');var _helper=require('../utils/helper');var _analytics=require('../utils/analytics');var _analytics2=_interopRequireDefault(_analytics);var _maps=require('./maps');var _graphQL=require('../utils/graphQL');var _graphQL2=_interopRequireDefault(_graphQL);var _constants=require('../utils/constants');var _transform=require('../utils/transform');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function loadPopularSuggestions(componentId){return function(dispatch,getState){var _getState=getState(),config=_getState.config,appbaseRef=_getState.appbaseRef,props=_getState.props,internalValues=_getState.internalValues;var isAppbaseEnabled=config&&config.enableAppbase;var componentProps=props[componentId];var internalValue=internalValues[componentId];var value=internalValue&&internalValue.value||'';if(isAppbaseEnabled&&(componentProps.enablePopularSuggestions||componentProps.enableQuerySuggestions)){var suggQuery=(0,_utils.getSuggestionQuery)(getState,componentId);appbaseRef.getQuerySuggestions(suggQuery).then(function(suggestions){var querySuggestion=suggestions[(0,_utils.getQuerySuggestionsId)(componentId)];if(value){dispatch((0,_misc.setPopularSuggestions)(querySuggestion&&querySuggestion.hits&&querySuggestion.hits.hits,componentId.split('__internal')[0]));}else{dispatch((0,_misc.setDefaultPopularSuggestions)(querySuggestion&&querySuggestion.hits&&querySuggestion.hits.hits,componentId.split('__internal')[0]));}}).catch(function(e){(0,_utils.handleError)({orderOfQueries:[componentId],error:e},getState,dispatch);});}};}function msearch(query,orderOfQueries){var appendToHits=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var isInternalComponent=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var appendToAggs=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var componentType=arguments[5];return function(dispatch,getState){var _getState2=getState(),appbaseRef=_getState2.appbaseRef,config=_getState2.config,headers=_getState2.headers,analytics=_getState2.analytics,selectedValues=_getState2.selectedValues;var searchHeaders={};var suggestionsComponents=[_constants.componentTypes.dataSearch,_constants.componentTypes.categorySearch];var isSuggestionsQuery=isInternalComponent&&suggestionsComponents.indexOf(componentType)!==-1;if(config.analytics){if(config.analyticsConfig.suggestionAnalytics&&isSuggestionsQuery){var suggestionsSearchValue=analytics.suggestionsSearchValue;var shouldIncludeQuery=!!(config.analyticsConfig.emptyQuery||suggestionsSearchValue);if(shouldIncludeQuery){searchHeaders={'X-Search-Query':suggestionsSearchValue||''};}}else{var searchValue=analytics.searchValue,searchId=analytics.searchId;var filterString=(0,_analytics2.default)(selectedValues);if(searchId){searchHeaders=_extends({'X-Search-Id':searchId,'X-Search-Query':searchValue||''},filterString&&{'X-Search-Filters':filterString});}else{var _shouldIncludeQuery=!!(config.analyticsConfig.emptyQuery||searchValue);searchHeaders=_extends(_shouldIncludeQuery&&{'X-Search-Query':searchValue||''},filterString&&{'X-Search-Filters':filterString});}}if(config.analyticsConfig.searchStateHeader){var searchState=(0,_helper.getSearchState)(getState(),true);if(searchState&&Object.keys(searchState).length){searchHeaders['X-Search-State']=JSON.stringify(searchState);}}if(config.analyticsConfig.userId){searchHeaders['X-User-Id']=config.analyticsConfig.userId;}if(config.analyticsConfig.customEvents){searchHeaders['X-Search-CustomEvent']=(0,_analytics.parseCustomEvents)(config.analyticsConfig.customEvents);}}orderOfQueries.forEach(function(component){dispatch((0,_misc.setLoading)(component,true));dispatch((0,_misc.setError)(component,null));});if(config.graphQLUrl){(0,_graphQL2.default)(config.graphQLUrl,config.url,config.credentials,config.app,query).then(function(res){(0,_utils.handleResponseMSearch)({res:res,isSuggestionsQuery:isSuggestionsQuery,orderOfQueries:orderOfQueries,appendToHits:appendToHits,appendToAggs:appendToAggs},getState,dispatch);}).catch(function(err){(0,_utils.handleError)({orderOfQueries:orderOfQueries,error:err},getState,dispatch);});}else{appbaseRef.setHeaders(_extends({},headers,searchHeaders));appbaseRef.msearch({type:config.type==='*'?'':config.type,body:query}).then(function(res){(0,_utils.handleResponseMSearch)({res:res,isSuggestionsQuery:isSuggestionsQuery,orderOfQueries:orderOfQueries,appendToHits:appendToHits,appendToAggs:appendToAggs},getState,dispatch);}).catch(function(err){(0,_utils.handleError)({orderOfQueries:orderOfQueries,error:err},getState,dispatch);});}};}function appbaseSearch(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},query=_ref.query,orderOfQueries=_ref.orderOfQueries,_ref$appendToHits=_ref.appendToHits,appendToHits=_ref$appendToHits===undefined?false:_ref$appendToHits,_ref$isInternalCompon=_ref.isInternalComponent,isInternalComponent=_ref$isInternalCompon===undefined?false:_ref$isInternalCompon,_ref$appendToAggs=_ref.appendToAggs,appendToAggs=_ref$appendToAggs===undefined?false:_ref$appendToAggs,componentType=_ref.componentType,componentId=_ref.componentId;return function(dispatch,getState){var _getState3=getState(),appbaseRef=_getState3.appbaseRef,config=_getState3.config,headers=_getState3.headers;var isAnalyticsEnabled=false;if(config){if((0,_utils.isPropertyDefined)(config.analytics)){isAnalyticsEnabled=config.analytics;}else if(config.analyticsConfig){if((0,_utils.isPropertyDefined)(config.analyticsConfig.recordAnalytics)){isAnalyticsEnabled=config.analyticsConfig.recordAnalytics;}else if((0,_utils.isPropertyDefined)(config.analyticsConfig.analytics)){isAnalyticsEnabled=config.analyticsConfig.analytics;}}}var settings={recordAnalytics:isAnalyticsEnabled};if(config.analyticsConfig){settings.userId=(0,_utils.isPropertyDefined)(config.analyticsConfig.userId)?config.analyticsConfig.userId:undefined;settings.enableQueryRules=(0,_utils.isPropertyDefined)(config.analyticsConfig.enableQueryRules)?config.analyticsConfig.enableQueryRules:undefined;settings.customEvents=(0,_utils.isPropertyDefined)(config.analyticsConfig.customEvents)?config.analyticsConfig.customEvents:undefined;}orderOfQueries.forEach(function(component){dispatch((0,_misc.setLoading)(component,true));dispatch((0,_misc.setError)(component,null));});appbaseRef.setHeaders(_extends({},headers));if(isInternalComponent){dispatch(loadPopularSuggestions(componentId));}appbaseRef.reactiveSearchv3(query,settings).then(function(res){(0,_utils.handleResponse)({res:res,isInternalComponent:isInternalComponent,orderOfQueries:orderOfQueries,appendToHits:appendToHits,appendToAggs:appendToAggs,componentType:componentType,componentId:componentId},getState,dispatch);}).catch(function(err){(0,_utils.handleError)({orderOfQueries:orderOfQueries,error:err},getState,dispatch);});};}function executeQuery(componentId){var executeWatchList=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var mustExecuteMapQuery=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var componentType=arguments[3];var metaOptions=arguments[4];return function(dispatch,getState){var _getState4=getState(),queryLog=_getState4.queryLog,stream=_getState4.stream,appbaseRef=_getState4.appbaseRef,config=_getState4.config,mapData=_getState4.mapData,watchMan=_getState4.watchMan,dependencyTree=_getState4.dependencyTree,queryList=_getState4.queryList,queryOptions=_getState4.queryOptions,queryListener=_getState4.queryListener,props=_getState4.props;var componentList=[componentId];var finalQuery=[];var appbaseQuery={};var orderOfQueries=[];var isAppbaseEnabled=config&&config.enableAppbase;if(executeWatchList){var watchList=watchMan[componentId]||[];componentList=[].concat(_toConsumableArray(componentList),_toConsumableArray(watchList));}var matchAllQuery={match_all:{}};componentList.forEach(function(component){var _buildQuery=(0,_helper.buildQuery)(component,dependencyTree,queryList,queryOptions),queryObj=_buildQuery.queryObj,options=_buildQuery.options;var validOptions=['aggs','from','sort'];if(queryObj&&!!Object.keys(queryObj).length||options&&Object.keys(options).some(function(item){return validOptions.includes(item);})){if(!queryObj||queryObj&&!Object.keys(queryObj).length){queryObj=_extends({},matchAllQuery);}var currentQuery=_extends({query:_extends({},queryObj)},options,queryOptions[component]);var queryToLog=_extends({query:_extends({},queryObj)},options,queryOptions[component]);var oldQuery=queryLog[component];if(mustExecuteMapQuery||!(0,_helper.isEqual)(currentQuery,oldQuery)){orderOfQueries=[].concat(_toConsumableArray(orderOfQueries),[component]);dispatch((0,_misc.logQuery)(component,queryToLog));var isMapComponent=Object.keys(mapData).includes(component);if(isMapComponent&&mapData[component].query){var existingQuery=currentQuery.query;currentQuery.query={bool:{must:[existingQuery,mapData[component].query]}};if(!mapData[component].persistMapQuery){dispatch((0,_maps.updateMapData)(componentId,null,false));}var _getState5=getState(),combinedLog=_getState5.combinedLog;if((0,_helper.isEqual)(combinedLog[component],currentQuery))return;dispatch((0,_misc.logCombinedQuery)(component,currentQuery));}(0,_utils.executeQueryListener)(queryListener[component],oldQuery,currentQuery);if(stream[component]&&stream[component].status){if(stream[component].ref){stream[component].ref.stop();}var ref=appbaseRef.searchStream({type:config.type==='*'?'':config.type,body:currentQuery},function(response){if(response._id){dispatch((0,_hits.pushToStreamHits)(component,response));}},function(error){if(queryListener[component]&&queryListener[component].onError){queryListener[component].onError(error);}console.warn(error);dispatch((0,_misc.setError)(component,error));dispatch((0,_misc.setLoading)(component,false));});dispatch((0,_misc.setStreaming)(component,true,ref));}if(isAppbaseEnabled){var query=(0,_transform.getRSQuery)(component,(0,_transform.extractPropsFromState)(getState(),component,metaOptions?{from:metaOptions.from}:null));if(query){appbaseQuery=_extends({},appbaseQuery,_defineProperty({},component,query),(0,_transform.getDependentQueries)(getState(),component,orderOfQueries));}}else{finalQuery=[].concat(_toConsumableArray(finalQuery),[{preference:component},currentQuery]);}}}});if(isAppbaseEnabled){finalQuery=Object.keys(appbaseQuery).map(function(component){return appbaseQuery[component];});}if(finalQuery.length){if(isAppbaseEnabled){dispatch(appbaseSearch({query:finalQuery,orderOfQueries:orderOfQueries,isInternalComponent:componentId.endsWith('__internal'),componentType:componentType,props:props[componentId],componentId:componentId}));}else{dispatch(msearch(finalQuery,orderOfQueries,false,componentId.endsWith('__internal'),undefined,componentType));}}};}function setQueryOptions(component,queryOptions){var execute=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;return function(dispatch){dispatch((0,_misc.updateQueryOptions)(component,queryOptions));if(execute){dispatch(executeQuery(component,true));}};}function updateQuery(_ref2){var componentId=_ref2.componentId,query=_ref2.query,value=_ref2.value,_ref2$label=_ref2.label,label=_ref2$label===undefined?null:_ref2$label,_ref2$showFilter=_ref2.showFilter,showFilter=_ref2$showFilter===undefined?true:_ref2$showFilter,_ref2$URLParams=_ref2.URLParams,URLParams=_ref2$URLParams===undefined?false:_ref2$URLParams,_ref2$componentType=_ref2.componentType,componentType=_ref2$componentType===undefined?null:_ref2$componentType,_ref2$category=_ref2.category,category=_ref2$category===undefined?null:_ref2$category,_ref2$meta=_ref2.meta,meta=_ref2$meta===undefined?{}:_ref2$meta;var execute=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return function(dispatch){var queryToDispatch=query;if(query&&query.query){queryToDispatch=query.query;}if(!componentId.endsWith('__internal')){dispatch((0,_value.setValue)(componentId,value,label,showFilter,URLParams,componentType,category,meta));if(componentType===_constants.componentTypes.dynamicRangeSlider){dispatch((0,_value.setInternalValue)((0,_transform.getHistogramComponentID)(componentId),value,componentType,category,meta));}else{dispatch((0,_value.setInternalValue)(componentId+'__internal',value,componentType,category,meta));}}else{dispatch((0,_value.setInternalValue)(componentId,value,componentType,category,meta));}dispatch((0,_misc.setQuery)(componentId,queryToDispatch));if(execute)dispatch(executeQuery(componentId,true,false,componentType));};}function loadMore(component,newOptions){var appendToHits=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var appendToAggs=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return function(dispatch,getState){var store=getState();var _buildQuery2=(0,_helper.buildQuery)(component,store.dependencyTree,store.queryList,store.queryOptions),queryObj=_buildQuery2.queryObj,options=_buildQuery2.options;var queryLog=store.queryLog;if(!options)options={};options=_extends({},options,newOptions);if(!queryObj||queryObj&&!Object.keys(queryObj).length){queryObj={match_all:{}};}var currentQuery=_extends({query:_extends({},queryObj)},options);if((0,_helper.isEqual)(queryLog[component],currentQuery))return;dispatch((0,_misc.logQuery)(component,currentQuery));if(store.config&&store.config.enableAppbase){var appbaseQuery={};var componentProps=store.props[component]||{};var compositeAggregationField=componentProps.aggregationField;var queryType=_transform.componentToTypeMap[componentProps.componentType];if(queryType===_constants.queryTypes.term){compositeAggregationField=componentProps.dataField;}var query=(0,_transform.getRSQuery)(component,(0,_transform.extractPropsFromState)(store,component,{from:options.from,after:store.aggregations[component]&&store.aggregations[component][compositeAggregationField]&&store.aggregations[component][compositeAggregationField].after_key||undefined}));appbaseQuery=_extends(_defineProperty({},component,query),(0,_transform.getDependentQueries)(getState(),component,[]));var finalQuery=Object.keys(appbaseQuery).map(function(c){return appbaseQuery[c];});dispatch(appbaseSearch({query:finalQuery,orderOfQueries:[component],appendToHits:appendToHits,appendToAggs:appendToAggs}));}else{var _finalQuery=[{preference:component},currentQuery];dispatch(msearch(_finalQuery,[component],appendToHits,false,appendToAggs));}};}